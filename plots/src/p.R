require(ggplot2)
require(data.table)
require(plyr)
require(scales)

theme_set(theme_bw())

methods <- c("BPF.HIER", "BPF", "LDA", "MF", "NMF")
datasets <- c("mendeley"="Mendeley","nyt"="New York Times","echonest"="Echo Nest","netflix45"="Netflix (implicit)","netflix"="Netflix (explicit)")

########################################
# plot simple descriptives
########################################

#
# users
#

# read user activity by dataset
users <- adply(names(datasets), 1, function(dataset) {
  tsv <- sprintf('../data/%s/users.tsv', dataset)
  users <- read.table(tsv, header=F, col.names=c('user', 'activity'))
})
users$X1 <- names(datasets)[users$X1]
names(users)[1] <- "dataset"

# clean up dataset labels and remove netflix implicit
users <- transform(users, dataset=revalue(dataset, datasets))
users <- transform(users, dataset=factor(as.character(dataset), datasets))
users <- subset(users, dataset != "Netflix (implicit)")

# plot distribution of user activity by dataset
plot.data <- ddply(users, c("dataset","activity"), summarize, num.users=length(user))
p <- ggplot(data=plot.data, aes(x=activity, y=num.users))
p <- p + geom_point()
p <- p + scale_x_log10(labels=comma, breaks=10^(0:4)) + scale_y_log10(labels=comma, breaks=10^(0:6))
p <- p + facet_wrap(~ dataset, nrow=1)
p <- p + xlab('User activity') + ylab('Number of users')
ggsave(p, filename='../../KDD-paper/figures/user_activity.pdf', width=10, height=2.5)
p

# plot cdf of user activity by dataset
plot.data <- ddply(users, c("dataset","activity"), summarize, num.users=length(user))
plot.data <- ddply(plot.data, "dataset", transform, frac.users=rev(cumsum(rev(num.users)))/sum(num.users))
p <- ggplot(data=plot.data, aes(x=activity, y=frac.users))
p <- p + geom_line()
p <- p + scale_x_log10(labels=comma, breaks=10^(0:3))
p <- p + scale_y_continuous(labels=percent)
p <- p + facet_wrap(~ dataset, nrow=1)
p <- p + xlab('Number of user views') + ylab('Fraction of users')
ggsave(p, filename='../../KDD-paper/figures/user_activity_cdf.pdf', width=10, height=2.5)
p


#
# items
#

# read item popularity by dataset
items <- adply(names(datasets), 1, function(dataset) {
  tsv <- sprintf('../data/%s/items.tsv', dataset)
  items <- read.table(tsv, header=F, col.names=c('item', 'popularity'))
})
items$X1 <- names(datasets)[items$X1]
names(items)[1] <- "dataset"
items <- transform(items, dataset=revalue(dataset, datasets))
items <- transform(items, dataset=factor(as.character(dataset), datasets))

# clean up dataset labels and remove netflix implicit
items <- transform(items, dataset=revalue(dataset, datasets))
items <- transform(items, dataset=factor(as.character(dataset), datasets))
items <- subset(items, dataset != "Netflix (implicit)")

# plot distribution of item activity by dataset
plot.data <- ddply(items, c("dataset","popularity"), summarize, num.items=length(item))
p <- ggplot(data=plot.data, aes(x=popularity, y=num.items))
p <- p + geom_point()
p <- p + scale_x_log10(labels=comma, breaks=10^(0:4)) + scale_y_log10(labels=comma, breaks=10^(0:6))
p <- p + facet_wrap(~ dataset, nrow=1)
p <- p + xlab('Item popularity') + ylab('Number of items')
ggsave(p, filename='../../KDD-paper/figures/item_popularity.pdf', width=10, height=2.5)
p

# plot cdf of item popularity by dataset
plot.data <- ddply(items, c("dataset","popularity"), summarize, num.items=length(item))
plot.data <- ddply(plot.data, "dataset", transform, frac.items=rev(cumsum(rev(num.items)))/sum(num.items))
p <- ggplot(data=plot.data, aes(x=popularity, y=frac.items))
p <- p + geom_line()
p <- p + scale_x_log10(labels=comma, breaks=10^(0:4))
p <- p + scale_y_continuous(labels=percent)
p <- p + facet_wrap(~ dataset, nrow=1)
p <- p + xlab('Number of item views') + ylab('Fraction of items')
ggsave(p, filename='../../KDD-paper/figures/item_popularity_cdf.pdf', width=10, height=2.5)
p



########################################
# read precision and coverage data frames
########################################

precision.by.user <- data.frame()
recall.by.user <- data.frame()
coverage.by.item <- data.frame()
for (dataset in names(datasets)) {
  print(dataset)

  # notes:
  # netflix45 is implicit, where only ratings >= 4 are treated as (binary) observations
  # netflix is explicit, where all rating values are modeled
  #  the method here is "mf" instead of "mfpop", as no negative sampling is used,
  #  so output/netflix/mf is symlinked to output/netflix/mfpop
  # in both cases the test set involves prediction of ratings >= 4 (items users "like")
  for (method in c("bpf.hier", "bpf", "lda", "nmf", "mfpop", "mfunif")) {
      tsv <- sprintf('../output/%s/%s/precision.txt', dataset, method)
      print(tsv)
      if (file.exists(tsv))
        precision.by.user <- rbind(precision.by.user,
                                   read.table(tsv, header=T))
      tsv <- sprintf('../output/%s/%s/recall.txt', dataset, method)
      print(tsv)
      if (file.exists(tsv))
       recall.by.user <- rbind(recall.by.user,
                               read.table(tsv, header=T))
    }
}


#######################################
# preprocessing
########################################

# remove users with missing activity from the training file
precision.by.user <- subset(precision.by.user, !is.na(activity))
recall.by.user <- subset(recall.by.user, !is.na(activity))

# keep only mfpop, renaming to mf
# clean up dataset names
precision.by.user <- subset(precision.by.user, method != "MFUNIF")
precision.by.user <- transform(precision.by.user,
                               method=revalue(method, c("MFPOP"="MF")),
                               dataset=revalue(dataset, datasets))
recall.by.user <- subset(recall.by.user, method != "MFUNIF")
recall.by.user <- transform(recall.by.user,
                            method=revalue(method, c("MFPOP"="MF")),
                            dataset=revalue(dataset, datasets))

# set order of methods and datasets for all plots
precision.by.user <- transform(precision.by.user,
                               dataset=factor(as.character(dataset), datasets),
                               method=factor(as.character(method), methods))
recall.by.user <- transform(recall.by.user,
                            dataset=factor(as.character(dataset), datasets),
                            method=factor(as.character(method), methods))


# make all evaluations for rank 100 and 20 recommendations
N <- 20
rank <- 100

########################################
# precision/recall at N
########################################

# plot mean precision at N recs for methods and datasets
plot.data <- subset(precision.by.user, num.recs==N & K==rank)
plot.data <- ddply(plot.data, c("dataset","method","K","num.recs"), summarize, mean.precision=mean(precision))
p <- ggplot(plot.data, aes(x=dataset, y=mean.precision))
p <- p + geom_point(aes(color=method), size=1)
p <- p + geom_hline(aes(yintercept=mean.precision, colour=method, linetype=method), size=1)
p <- p + facet_wrap(~ dataset, nrow=1, scale="free")
p <- p + xlab("") + ylab('Normalized mean precision')
p <- p + scale_y_continuous(labels=percent)
p <- p + theme(legend.title=element_blank())
p <- p + theme(axis.text.x=element_blank(), axis.ticks.x=element_blank(), axis.title.x=element_blank())
ggsave(p, filename=sprintf('../../KDD-paper/figures/mean_precision_at_%d.pdf', N), width=10, height=2.5)
p


# plot mean recall at N recs for methods and datasets
plot.data <- subset(recall.by.user, num.recs==N & K==rank)
plot.data <- ddply(plot.data, c("dataset","method","K","num.recs"), summarize, mean.recall=mean(recall))
p <- ggplot(plot.data, aes(x=dataset, y=mean.recall))
p <- p + geom_point(aes(color=method), size=1)
p <- p + geom_hline(aes(yintercept=mean.recall, colour=method, linetype=method), size=1)
p <- p + facet_wrap(~ dataset, nrow=1, scale="free")
p <- p + xlab("") + ylab('Mean recall')
p <- p + scale_y_continuous(labels=percent)
p <- p + theme(legend.title=element_blank())
p <- p + theme(axis.text.x=element_blank(), axis.ticks.x=element_blank(), axis.title.x=element_blank())
ggsave(p, filename=sprintf('../../KDD-paper/figures/mean_recall_at_%d.pdf', N), width=10, height=2.5)
p


########################################
# precision/recall by number of recs
########################################

# plot mean precision by number of recs for methods and datasets
plot.data <- subset(precision.by.user, K==rank)
plot.data <- ddply(plot.data, c("dataset","method","K","num.recs"), summarize, mean.precision=mean(precision))
p <- ggplot(plot.data, aes(x=num.recs, y=mean.precision))
p <- p + geom_line(aes(linetype=as.factor(method), colour=as.factor(method)))
p <- p + xlab('Number of recommendations') + ylab('Normalized mean precision')
p <- p + scale_x_continuous(breaks=c(10,50,100)) + scale_y_continuous(labels=percent)
p <- p + theme(legend.title=element_blank())
p <- p + facet_wrap(~ dataset, nrow=1, scale="free_y")
ggsave(p, filename='../../KDD-paper/figures/mean_precision_by_num_recs.pdf', width=10, height=2.5)
p


# plot mean recall by number of recs for methods and datasets
plot.data <- subset(recall.by.user, K==rank)
plot.data <- ddply(plot.data, c("dataset","method","K","num.recs"), summarize, mean.recall=mean(recall))
p <- ggplot(plot.data, aes(x=num.recs, y=mean.recall))
p <- p + geom_line(aes(linetype=as.factor(method), colour=as.factor(method)))
p <- p + xlab('Number of recommendations') + ylab('Mean recall')
p <- p + scale_x_continuous(breaks=c(10,50,100)) + scale_y_continuous(labels=percent)
p <- p + theme(legend.title=element_blank())
p <- p + facet_wrap(~ dataset, nrow=1, scale="free_y")
ggsave(p, filename='../../KDD-paper/figures/mean_recall_by_num_recs.pdf', width=10, height=2.5)
p


########################################
# precision/recall by user activity
########################################

# plot mean precision by user activity percentile
percentiles <- seq(0.05,1,0.05)
plot.data <- subset(precision.by.user, num.recs==N)
plot.data <- ddply(plot.data, c("dataset","method"), function(df) {
  adply(percentiles, 1, function(p) {
    with(subset(df, activity <= quantile(activity, p)), mean(precision, na.rm=T))
  })
})
plot.data$X1 <- percentiles[plot.data$X1]
names(plot.data) <- c("dataset","method","percentile","mean.precision")
p <- ggplot(plot.data, aes(x=percentile, y=mean.precision))
p <- p + geom_line(aes(color=method, linetype=method))
p <- p + facet_wrap(~ dataset, nrow=1, scale="free_y")
p <- p + scale_x_continuous(labels=percent, breaks=c(0.1, 0.5, 0.9))
p <- p + scale_y_continuous(labels=percent)
p <- p + xlab('User percentile by activity') + ylab('Normalized mean precision')
p <- p + theme(legend.title=element_blank())
ggsave(p, filename=sprintf('../../KDD-paper/figures/mean_precision_at_%d_by_user_percentile.pdf', N), width=10, height=2.5)
p


# plot mean recall by user activity percentile
percentiles <- seq(0.05,1,0.05)
plot.data <- subset(recall.by.user, num.recs==N)
plot.data <- ddply(plot.data, c("dataset","method"), function(df) {
  adply(percentiles, 1, function(p) {
    with(subset(df, activity <= quantile(activity, p)), mean(recall, na.rm=T))
  })
})
plot.data$X1 <- percentiles[plot.data$X1]
names(plot.data) <- c("dataset","method","percentile","mean.recall")
p <- ggplot(plot.data, aes(x=percentile, y=mean.recall))
p <- p + geom_line(aes(color=method, linetype=method))
p <- p + facet_wrap(~ dataset, nrow=1, scale="free_y")
p <- p + scale_x_continuous(labels=percent, breaks=c(0.1, 0.5, 0.9))
p <- p + scale_y_continuous(labels=percent)
p <- p + xlab('User percentile by activity') + ylab('Mean recall')
p <- p + theme(legend.title=element_blank())
ggsave(p, filename=sprintf('../../KDD-paper/figures/mean_recall_at_%d_by_user_percentile.pdf', N), width=10, height=2.5)
p



stop("scratch")
########################################
# SCRATCH
########################################

precision.by.user$dataset <- revalue(precision.by.user$dataset, c("mendeley"="mdy", "echonest"="ecn", "nyt"="nyt","netflix"="nfx", "netflix45"="n45"))
recall.by.user$dataset <- revalue(recall.by.user$dataset, c("mendeley"="mdy", "echonest"="ecn", "nyt"="nyt","netflix"="nfx", "netflix45"="n45"))


plot.data <- ddply(precision.by.user, c("dataset","method","K","num.recs"), summarize, mean.precision=mean(precision))
plot.data <- subset(plot.data, num.recs %in%  c(10,100))
p <- ggplot(plot.data, aes(x=as.factor(num.recs), y=mean.precision))
p <- p + geom_point(aes(color=as.factor(method)), size=3)
p <- p + geom_hline(aes(yintercept=mean.precision, colour=as.factor(method)), size=3)
p <- p + xlab("") + ylab('Normalized mean precision')
p <- p + scale_y_continuous(labels=percent)
p <- p + theme(legend.title=element_blank()) #, legend.position="none") #c(0.8,0.75))
p <- p + facet_wrap(dataset ~ num.recs, nrow=1, scale="free")
p <- p + theme(axis.text.x=element_blank(), axis.ticks.x=element_blank(), axis.title.x=element_blank())
p <- p + theme(strip.text.x = element_text(size = 8, colour = "blue", face="bold"))
ggsave(p, filename='../../KDD-paper/figures/meanprecision2.pdf', width=10, height=2.5)
p

plot.data <- ddply(recall.by.user, c("dataset","method","K","num.recs"), summarize, mean.recall=mean(recall))
plot.data <- subset(plot.data, num.recs %in%  c(10,100))
p <- ggplot(plot.data, aes(x=as.factor(num.recs), y=mean.recall))
p <- p + geom_point(aes(color=as.factor(method)), size=3)
p <- p + geom_hline(aes(yintercept=mean.recall, colour=as.factor(method)), size=3)
p <- p + xlab("") + ylab('Mean recall')
p <- p + scale_y_continuous(labels=percent)
p <- p + theme(legend.title=element_blank())
p <- p + facet_wrap(dataset ~ num.recs, nrow=1, scale="free")
p <- p + theme(axis.text.x=element_blank(), axis.ticks.x=element_blank(), axis.title.x=element_blank())
p <- p + theme(strip.text.x = element_text(size = 8, colour = "blue", face="bold"))
ggsave(p, filename='../../KDD-paper/figures/meanrecall2.pdf', width=10, height=2.5)
p


N <- 20
q <- subset(precision.by.user, num.recs==N)
plot.data1 <- ddply(q, .(), subset, activity < quantile(activity, 0.1))
plot.data1 <- ddply(plot.data1, c("dataset", "method", "K"), summarize, mean.precision=mean(precision), stdev=sqrt(var(precision)), freq=length(K))
plot.data1 <- transform(plot.data1, qtl=10)
plot.data2 <- ddply(q, .(), subset, activity < quantile(activity, 0.9))
plot.data2 <- ddply(plot.data2, c("dataset", "method", "K"), summarize, mean.precision=mean(precision), stdev=sqrt(var(precision)), freq=length(K))
plot.data2 <- transform(plot.data2, qtl=90)
plot.data <- rbind(plot.data1, plot.data2)
p <- ggplot(plot.data, aes(x=as.factor(qtl), y=mean.precision))
p <- p + geom_point(aes(color=as.factor(method)), size=3)
p <- p + geom_hline(aes(yintercept=mean.precision, colour=as.factor(method)), size=3)
p <- p + xlab("User activity") + ylab('Normalized mean precision')
p <- p + scale_y_continuous(labels=percent)
p <- p + theme(legend.title=element_blank()) #, legend.position="none") #c(0.8,0.75))
p <- p + facet_wrap(dataset ~ qtl, nrow=1, scale="free")
p <- p + theme(axis.text.x=element_blank(), axis.ticks.x=element_blank(), axis.title.x=element_blank())
p <- p + theme(strip.text.x = element_text(size = 8, colour = "blue", face="bold"))
ggsave(p, filename='../../KDD-paper/figures/useractivity-meanprecision2.pdf', width=10, height=2.5)
p

N <- 20
q <- subset(recall.by.user, num.recs==N)
plot.data1 <- ddply(q, .(), subset, activity < quantile(activity, 0.1))
plot.data1 <- ddply(plot.data1, c("dataset", "method", "K"), summarize, mean.recall=mean(recall), stdev=sqrt(var(recall)), freq=length(K))
plot.data1 <- transform(plot.data1, qtl=10)
plot.data2 <- ddply(q, .(), subset, activity < quantile(activity, 0.9))
plot.data2 <- ddply(plot.data2, c("dataset", "method", "K"), summarize, mean.recall=mean(recall), stdev=sqrt(var(recall)), freq=length(K))
plot.data2 <- transform(plot.data2, qtl=90)
plot.data <- rbind(plot.data1, plot.data2)
p <- ggplot(plot.data, aes(x=as.factor(qtl), y=mean.recall))
p <- p + geom_point(aes(color=as.factor(method)), size=3)
p <- p + geom_hline(aes(yintercept=mean.recall, colour=as.factor(method)), size=3)
p <- p + xlab("User activity") + ylab('Mean recall')
p <- p + scale_y_continuous(labels=percent)
p <- p + theme(legend.title=element_blank()) #, legend.position="none") #c(0.8,0.75))
p <- p + facet_wrap(dataset ~ qtl, nrow=1, scale="free")
p <- p + theme(axis.text.x=element_blank(), axis.ticks.x=element_blank(), axis.title.x=element_blank())
p <- p + theme(strip.text.x = element_text(size = 8, colour = "blue", face="bold"))
ggsave(p, filename='../../KDD-paper/figures/useractivity-meanrecall2.pdf', width=10, height=2.5)
p
